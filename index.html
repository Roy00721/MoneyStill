<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ffffff">
    <title>錢還在 - 記帳APP</title>
    <link rel="icon" href="icon.svg" type="image/svg+xml">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="styles.css">
    <!-- Firebase SDK -->
    <script type="module" src="firebase-config.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, addDoc, getDocs, deleteDoc, query, where, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { firebaseConfig, validateFirebaseConfig, checkFirebaseSetup, diagnoseFirebaseSetup } from './firebase-config.js';

        // 驗證 Firebase 配置
        if (!validateFirebaseConfig()) {
            console.error('Firebase 配置無效，請檢查 firebase-config.js');
            checkFirebaseSetup();
        } else {
            console.log('Firebase 配置驗證通過');
        }

        try {
            // Initialize Firebase
            console.log('正在初始化 Firebase...');
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const provider = new GoogleAuthProvider();
            const db = getFirestore(app);

            // 先設置認證持久化，再設置全域變數
            import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js').then(({ setPersistence, browserLocalPersistence }) => {
                return setPersistence(auth, browserLocalPersistence);
            }).then(() => {
                console.log('Firebase Auth 持久化已設置');

                // 設置全域變數
                window.firebaseAuth = { auth, provider, signInWithPopup, signOut };
                window.firestoreDB = {
                    db,
                    collection,
                    doc,
                    addDoc,
                    getDocs,
                    deleteDoc,
                    query,
                    where,
                    orderBy,
                    onSnapshot
                };
                console.log('Firebase 初始化完成', window.firebaseAuth);

                // 運行診斷檢查
                diagnoseFirebaseSetup();

            }).catch(error => {
                console.error('設置 Auth 持久化失敗:', error);
                // 即使持久化失敗，也要設置基本功能
                window.firebaseAuth = { auth, provider, signInWithPopup, signOut };
                window.firestoreDB = {
                    db,
                    collection,
                    doc,
                    addDoc,
                    getDocs,
                    deleteDoc,
                    query,
                    where,
                    orderBy,
                    onSnapshot
                };

                // 即使持久化失敗也運行診斷
                diagnoseFirebaseSetup();
            });

        } catch (error) {
            console.error('Firebase 初始化失敗:', error);
        }
    </script>
</head>
<body>
    <div class="app">
        <!-- 登入區域 -->
        <div id="auth-section" class="auth-section">
            <h1>錢還在</h1>
            <p>簡單的記帳應用</p>
            <button id="login-btn" class="btn primary">使用Google登入</button>
            <div id="user-info" class="user-info hidden">
                <img id="user-avatar" alt="用戶頭像">
                <span id="user-name"></span>
                <button id="logout-btn" class="btn secondary">登出</button>
            </div>
        </div>

        <!-- 記帳區域 -->
        <div id="accounting-section" class="accounting-section hidden">
            <header class="app-header">
                <h1>記帳</h1>
                <div class="balance">
                    <span>餘額：</span>
                    <span id="total-balance">0</span>
                    <span>元</span>
                </div>
            </header>

            <!-- 新增記帳項目 -->
            <div class="add-entry">
                <select id="entry-type">
                    <option value="income">收入</option>
                    <option value="expense">支出</option>
                </select>
                <input type="number" id="entry-amount" placeholder="金額" min="0" step="0.01">
                <input type="text" id="entry-description" placeholder="描述">
                <button id="add-entry-btn" class="btn primary">新增</button>
            </div>

            <!-- 記帳列表 -->
            <div class="entries-list">
                <h2>記帳記錄</h2>
                <div id="entries-container">
                    <!-- 記帳項目會動態加入這裡 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 載入應用模組 -->
    <script type="module">
        // 動態載入應用
        import('./app.js').then(() => {
            console.log('應用模組已載入');
            // 等待 Firebase 初始化完成
            const checkFirebaseReady = () => {
                if (window.firebaseAuth && window.MoneyStillApp) {
                    // Firebase 和應用類別都已準備好，創建實例
                    window.app = new window.MoneyStillApp();
                    console.log('MoneyStill 應用已初始化');
                } else {
                    console.log('等待 Firebase 初始化...', {
                        firebaseAuth: !!window.firebaseAuth,
                        MoneyStillApp: !!window.MoneyStillApp
                    });
                    // 稍後再檢查
                    setTimeout(checkFirebaseReady, 100);
                }
            };
            checkFirebaseReady();
        }).catch(error => {
            console.error('應用模組載入失敗:', error);
        });
    </script>
</body>
</html>
